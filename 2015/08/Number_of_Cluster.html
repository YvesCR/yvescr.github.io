<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>August coding dojo: Choosing the optimal number of cluster</title>
    <meta name="description" content="Personnal web site of a data scientist. Statistic, data-visualisation and hacks. R code and soon python.
">

    <link rel="stylesheet" href="http://yvescr.github.io/css/main.css">
    
	
	<script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-71940303-1', 'auto');
  ga('send', 'pageview');

</script>

  <body>

    <header class="site-header">


  <div class="wrapper">

    <a class="site-title" href="http://yvescr.github.io/" >Data Laborer </a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
      </a>
	
      <div class="trigger">
        
          
          <a class="page-link" href="http://yvescr.github.io/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">August coding dojo: Choosing the optimal number of cluster</h1>
    <p class="post-meta">Aug 18, 2015</p>
  </header>

  <article class="post-content">
    <p>At the last coding dojo, the interrogation we get was the following:
Is it possible to create a function which automatically define the optimal number of cluster?
As usual, the answer with R is: there is a package to answer this question.</p>

<h2> Training data set </h2>

<p>First, we generate some fake data:
Not too much separated, but not too messy. It is a simulation, not real life :)</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>

<span class="n">sd</span> <span class="o">&lt;-</span> <span class="m">30</span>

<span class="n">mat</span> <span class="o">=</span> <span class="n">data.frame</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">10</span><span class="p">),</span><span class="n">seq</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="m">120</span><span class="p">),</span><span class="n">seq</span><span class="p">(</span><span class="m">10</span><span class="o">:</span><span class="m">30</span><span class="p">))</span> <span class="o">+</span> <span class="n">rnorm</span><span class="p">(</span><span class="m">52</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sd</span><span class="p">),</span> 
                 <span class="n">y</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">10</span><span class="p">),</span><span class="n">seq</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="m">120</span><span class="p">),</span><span class="n">seq</span><span class="p">(</span><span class="m">300</span><span class="p">,</span><span class="m">320</span><span class="p">))</span><span class="o">+</span> <span class="n">rnorm</span><span class="p">(</span><span class="m">52</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sd</span><span class="p">)</span>
                 <span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">rep</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span> <span class="m">10</span><span class="p">),</span> <span class="n">rep</span><span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="m">21</span><span class="p">),</span> <span class="n">rep</span><span class="p">(</span><span class="s2">"c"</span><span class="p">,</span> <span class="m">21</span><span class="p">)))</span>

<span class="n">ggplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">mat</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">))</span> <span class="o">+</span>
    <span class="n">geom_point</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="m">4</span><span class="p">)</span> </code></pre></figure>

<p><img src="/blog/figure/source/2015-08-18-Number_of_Cluster/unnamed-chunk-1-1.png" alt="plot of chunk unnamed-chunk-1" /></p>

<h2> Analysis </h2>

<h3> Elbow plot </h3>
<p>Our main inspiration is that post on stackoverflow:</p>

<p><a href="http://stackoverflow.com/questions/15376075/cluster-analysis-in-r-determine-the-optimal-number-of-clusters">http://stackoverflow.com/questions/15376075/cluster-analysis-in-r-determine-the-optimal-number-of-clusters</a></p>

<p>And the help of the Nbclust package.</p>

<p>The first way to determine a reasonnable number of cluster that I learnt at school was the elbow plot.
The concept is to plot the sum of the distance between the centroid of the cluster and the point of the cluster by cluster.</p>

<p>The plot looks like an elbow and the classic rule is to take the number of cluster where the curve begin to flaten. Afterward, each new cluster is not really separated from the others.</p>

<p>Elbow plot:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">wss</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span><span class="m">-1</span><span class="p">)</span><span class="o">*</span><span class="n">sum</span><span class="p">(</span><span class="n">apply</span><span class="p">(</span><span class="n">mat</span><span class="p">[,</span> <span class="m">-3</span><span class="p">],</span><span class="m">2</span><span class="p">,</span><span class="n">var</span><span class="p">))</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">2</span><span class="o">:</span><span class="m">15</span><span class="p">)</span> <span class="n">wss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">sum</span><span class="p">(</span><span class="n">kmeans</span><span class="p">(</span><span class="n">mat</span><span class="p">[,</span> <span class="m">-3</span><span class="p">],</span>
                                       <span class="n">centers</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">$</span><span class="n">withinss</span><span class="p">)</span>

<span class="n">wss2</span> <span class="o">&lt;-</span> <span class="n">data.frame</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="m">15</span><span class="p">,</span> <span class="n">wss</span> <span class="o">=</span> <span class="n">wss</span><span class="p">)</span>

<span class="n">ggplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">wss2</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">wss</span><span class="p">))</span><span class="o">+</span>
    <span class="n">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">4</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">geom_line</span><span class="p">()</span> <span class="o">+</span>
  <span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="m">15</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Elbow plot"</span><span class="p">)</span></code></pre></figure>

<p><img src="/blog/figure/source/2015-08-18-Number_of_Cluster/unnamed-chunk-4-1.png" alt="plot of chunk unnamed-chunk-4" /></p>

<h3> The function NbClust </h3>

<p>The function NbClust test a consequent set of methods to determine the optimal number of clusters.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">res</span> <span class="o">&lt;-</span> <span class="n">NbClust</span><span class="p">(</span><span class="n">mat</span><span class="p">[,</span> <span class="m">-3</span><span class="p">],</span> <span class="n">diss</span><span class="o">=</span><span class="n">NULL</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="s2">"euclidean"</span><span class="p">,</span> <span class="n">min.nc</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">max.nc</span><span class="o">=</span><span class="m">6</span><span class="p">,</span> 
             <span class="n">method</span> <span class="o">=</span> <span class="s2">"kmeans"</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="s2">"all"</span><span class="p">)</span></code></pre></figure>

<p>The different method used (minus the graphical ones) and the number of clusters picked by each:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">res</span><span class="o">$</span><span class="n">Best.nc</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">##                     KL       CH Hartigan     CCC   Scott     Marriot
## Number_clusters 5.0000   3.0000   3.0000  3.0000  3.0000           3
## Value_Index     6.5554 199.2098  63.1441 14.9607 65.9178 21080289130
##                    TrCovW   TraceW Friedman    Rubin Cindex     DB
## Number_clusters         4      3.0   3.0000   3.0000 6.0000 2.0000
## Value_Index     890540109 134929.1  15.8781 -10.8347 0.2913 0.5298
##                 Silhouette   Duda PseudoT2  Beale Ratkowsky     Ball
## Number_clusters     2.0000 2.0000   2.0000 2.0000    2.0000     3.00
## Value_Index         0.6672 0.3117  64.0523 2.1351    0.5392 91865.87
##                 PtBiserial Frey McClain   Dunn Hubert SDindex Dindex
## Number_clusters     2.0000    1  2.0000 2.0000      0   2.000      0
## Value_Index         0.8202   NA  0.3371 0.4349      0   0.017      0
##                   SDbw
## Number_clusters 3.0000
## Value_Index     0.1048</code></pre></figure>

<p>Most common value:(Without 0)</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">summary</span><span class="p">(</span><span class="n">res</span><span class="o">$</span><span class="n">Best.nc</span><span class="p">[</span><span class="m">1</span><span class="p">,][</span><span class="n">res</span><span class="o">$</span><span class="n">Best.nc</span><span class="p">[</span><span class="m">1</span><span class="p">,]</span><span class="o">!=</span> <span class="m">0</span><span class="p">])</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    1.00    2.00    3.00    2.75    3.00    6.00</code></pre></figure>

<p>In the end, the median of all this method is choose. In this case, 2.</p>

<h2> Result </h2>

<p>The plot:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">mat</span><span class="o">$</span><span class="n">res</span> <span class="o">&lt;-</span> <span class="n">res</span><span class="o">$</span><span class="n">Best.partition</span>

<span class="n">ggplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">mat</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">colour</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span> <span class="o">+</span>
    <span class="n">geom_point</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="m">4</span><span class="p">)</span></code></pre></figure>

<p><img src="/blog/figure/source/2015-08-18-Number_of_Cluster/unnamed-chunk-10-1.png" alt="plot of chunk unnamed-chunk-10" /></p>

<p>There is another approach we didn’t had time to look, but which seems promising:
The package BHC which does bayesian hierarchical clustering could also provide us an insight on the best cluster.</p>

	
	<div id="disqus_thread"></div>

	<script>
		/**
		 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
		 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
		 */
		/*
		var disqus_config = function () {
			this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
		};
		*/
		(function() {  // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');
			
			s.src = '//datalaborereu.disqus.com/embed.js';
			
			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

	<script id="dsq-count-scr" src="//datalaborereu.disqus.com/count.js" async></script>
	
  </article>

</div>

		
      </div>
    </div>
    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Data Laborer</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Data Laborer</li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="http://github.com/yvesCR">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">yvesCR</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Personnal web site of a data scientist. Statistic, data-visualisation and hacks. R code and soon python.
</p>
      </div>
    </div>

  </div>

</footer>

	
  </body>

</html>
